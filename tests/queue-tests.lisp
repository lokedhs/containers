(in-package :dhs-sequence-tests)

(declaim (optimize (safety 3) (speed 0) (debug 3)))

(defun check-with-tolerance (value expected tolerance)
  (fiveam:is (>= value (- expected tolerance)) "value is too small, value=~s, expected=~s, tolerance=~s" value expected tolerance)
  (fiveam:is (<= value (+ expected tolerance)) "value is too big, value=~s, expected=~s, tolerance=~s" value expected tolerance))

(defmacro define-queue-test ((name pop-fn-sym) &body body)
  (flet ((test-name (suffix)
           (intern (concatenate 'string (symbol-name name) "-" (symbol-name suffix)))))
    (alexandria:with-gensyms (queue-sym)
      `(progn
         (fiveam:test ,(test-name 'queue-pop)
           (macrolet ((,pop-fn-sym (,queue-sym) `(queue-pop ,,queue-sym)))
             ,@body))
         (fiveam:test ,(test-name 'queue-pop-wait)
           (macrolet ((,pop-fn-sym (,queue-sym) `(queue-pop-wait ,,queue-sym)))
             ,@body))
         (fiveam:test ,(test-name 'queue-pop-wait-with-timeout)
           (macrolet ((,pop-fn-sym (,queue-sym) `(queue-pop-wait ,,queue-sym :timeout 10)))
             ,@body))))))

(define-queue-test (test-simple-insert-remove queue-pop-fn)
  (let* ((q (make-blocking-queue))
         (n 10000)
         (orig (loop
                  for i from 0 below n
                  do (queue-push q i)
                  collect i)))
    (fiveam:is (not (empty-p q)))
    (fiveam:is (= (content-length q) n))
    (let ((content (loop
                      for i from 0 below n
                      collect (queue-pop-fn q))))
      (fiveam:is (equal content orig))
      (fiveam:is (empty-p q)))))


(define-queue-test (test-trailing-insert-remove queue-pop-fn)
  (let ((q (make-blocking-queue))
        (n 10000)
        (w 10)
        (i 0)
        (result nil))
    (loop
       repeat w
       do (queue-push q (incf i)))
    (fiveam:is (not (empty-p q)))
    (fiveam:is (= w (content-length q)))
    ;; Push and pop from the queue n times
    (loop
       repeat n
       do (queue-push q (incf i))
       do (push (queue-pop-fn q) result))
    (fiveam:is (not (empty-p q)))
    (fiveam:is (= w (content-length q)))
    (loop
       repeat w
       do (push (queue-pop-fn q) result))
    (fiveam:is (empty-p q))
    (fiveam:is (equal (loop for x from 1 to i collect x) (nreverse result)))))

(fiveam:test queue-with-timeout
  (let ((q (make-blocking-queue))
        (n 1000))
    (loop
       for i from 0 below n
       do (queue-push q i))
    (fiveam:is (= (content-length q) n))
    (let ((start-time (dhs-sequences::current-time))
          (result nil))
      (loop
         repeat (1+ n)
         do (push (queue-pop-wait q :timeout 0.4) result))
      (let* ((end-time (dhs-sequences::current-time))
             (delta (- end-time start-time)))
        (check-with-tolerance delta 0.4 0.1)
        (fiveam:is (equal (append (loop for i from 0 below n collect i)
                                  (list nil))
                          (nreverse result)))))))

(defparameter *queue-test-block* '((PUSH 0 1) (POP 1 0) (PUSH 0 1) (POP 1 0) (PUSH 0 1) (PUSH 1 2) (POP 2 1)
                                   (PUSH 1 2) (PUSH 2 3) (PUSH 3 4) (POP 4 3) (PUSH 3 4) (POP 4 3) (PUSH 3 4)
                                   (PUSH 4 5) (PUSH 5 6) (POP 6 5) (PUSH 5 6) (PUSH 6 7) (POP 7 6) (PUSH 6 7)
                                   (PUSH 7 8) (PUSH 8 9) (POP 9 8) (PUSH 8 9) (POP 9 8) (PUSH 8 9) (PUSH 9 10)
                                   (PUSH 10 11) (POP 11 10) (PUSH 10 11) (PUSH 11 12) (PUSH 12 13) (PUSH 13 14)
                                   (POP 14 13) (PUSH 13 14) (PUSH 14 15) (PUSH 15 16) (PUSH 16 17) (PUSH 17 18)
                                   (PUSH 18 19) (PUSH 19 20) (PUSH 20 21) (PUSH 21 22) (PUSH 22 23) (PUSH 23 24)
                                   (PUSH 24 25) (PUSH 25 26) (PUSH 26 27) (PUSH 27 28) (PUSH 28 29) (PUSH 29 30)
                                   (PUSH 30 31) (PUSH 31 32) (PUSH 32 33) (PUSH 33 34) (PUSH 34 35) (PUSH 35 36)
                                   (PUSH 36 37) (PUSH 37 38) (PUSH 38 39) (PUSH 39 40) (PUSH 40 41) (PUSH 41 42)
                                   (PUSH 42 43) (PUSH 43 44) (PUSH 44 45) (PUSH 45 46) (PUSH 46 47) (PUSH 47 48)
                                   (PUSH 48 49) (PUSH 49 50) (PUSH 50 51) (PUSH 51 52) (PUSH 52 53) (PUSH 53 54)
                                   (PUSH 54 55) (PUSH 55 56) (PUSH 56 57) (PUSH 57 58) (PUSH 58 59) (PUSH 59 60)
                                   (PUSH 60 61) (PUSH 61 62) (PUSH 62 63) (PUSH 63 64) (PUSH 64 65) (PUSH 65 66)
                                   (PUSH 66 67) (PUSH 67 68) (PUSH 68 69) (PUSH 69 70) (PUSH 70 71) (PUSH 71 72)
                                   (PUSH 72 73) (PUSH 73 74) (PUSH 74 75) (PUSH 75 76) (PUSH 76 77) (PUSH 77 78)
                                   (PUSH 78 79) (PUSH 79 80) (PUSH 80 81) (PUSH 81 82) (PUSH 82 83) (PUSH 83 84)
                                   (PUSH 84 85) (PUSH 85 86) (PUSH 86 87) (PUSH 87 88) (PUSH 88 89) (PUSH 89 90)
                                   (PUSH 90 91) (PUSH 91 92) (PUSH 92 93) (PUSH 93 94) (PUSH 94 95) (PUSH 95 96)
                                   (PUSH 96 97) (PUSH 97 98) (PUSH 98 99) (PUSH 99 100) (PUSH 100 101)
                                   (PUSH 101 102) (PUSH 102 103) (PUSH 103 104) (PUSH 104 105) (PUSH 105 106)
                                   (PUSH 106 107) (PUSH 107 108) (PUSH 108 109) (PUSH 109 110) (PUSH 110 111)
                                   (PUSH 111 112) (PUSH 112 113) (PUSH 113 114) (PUSH 114 115) (PUSH 115 116)
                                   (PUSH 116 117) (PUSH 117 118) (PUSH 118 119) (PUSH 119 120) (PUSH 120 121)
                                   (PUSH 121 122) (PUSH 122 123) (PUSH 123 124) (PUSH 124 125) (PUSH 125 126)
                                   (PUSH 126 127) (PUSH 127 128) (PUSH 128 129) (PUSH 129 130) (PUSH 130 131)
                                   (PUSH 131 132) (PUSH 132 133) (PUSH 133 134) (PUSH 134 135) (PUSH 135 136)
                                   (PUSH 136 137) (PUSH 137 138) (PUSH 138 139) (PUSH 139 140) (PUSH 140 141)
                                   (PUSH 141 142) (PUSH 142 143) (PUSH 143 144) (PUSH 144 145) (PUSH 145 146)
                                   (PUSH 146 147) (PUSH 147 148) (PUSH 148 149) (PUSH 149 150) (PUSH 150 151)
                                   (PUSH 151 152) (PUSH 152 153) (PUSH 153 154) (PUSH 154 155) (PUSH 155 156)
                                   (PUSH 156 157) (PUSH 157 158) (PUSH 158 159) (PUSH 159 160) (PUSH 160 161)
                                   (PUSH 161 162) (PUSH 162 163) (PUSH 163 164) (PUSH 164 165) (PUSH 165 166)
                                   (PUSH 166 167) (PUSH 167 168) (PUSH 168 169) (PUSH 169 170) (PUSH 170 171)
                                   (PUSH 171 172) (PUSH 172 173) (PUSH 173 174) (PUSH 174 175) (PUSH 175 176)
                                   (PUSH 176 177) (PUSH 177 178) (PUSH 178 179) (PUSH 179 180) (PUSH 180 181)
                                   (PUSH 181 182) (PUSH 182 183) (PUSH 183 184) (PUSH 184 185) (PUSH 185 186)
                                   (PUSH 186 187) (PUSH 187 188) (PUSH 188 189) (PUSH 189 190) (PUSH 190 191)
                                   (PUSH 191 192) (PUSH 192 193) (PUSH 193 194) (PUSH 194 195) (PUSH 195 196)
                                   (PUSH 196 197) (PUSH 197 198) (PUSH 198 199) (PUSH 199 200) (PUSH 200 201)
                                   (PUSH 201 202) (PUSH 202 203) (PUSH 203 204) (PUSH 204 205) (PUSH 205 206)
                                   (PUSH 206 207) (PUSH 207 208) (PUSH 208 209) (PUSH 209 210) (PUSH 210 211)
                                   (PUSH 211 212) (PUSH 212 213) (PUSH 213 214) (PUSH 214 215) (PUSH 215 216)
                                   (PUSH 216 217) (PUSH 217 218) (PUSH 218 219) (PUSH 219 220) (PUSH 220 221)
                                   (PUSH 221 222) (PUSH 222 223) (PUSH 223 224) (PUSH 224 225) (PUSH 225 226)
                                   (PUSH 226 227) (PUSH 227 228) (PUSH 228 229) (PUSH 229 230) (PUSH 230 231)
                                   (PUSH 231 232) (PUSH 232 233) (PUSH 233 234) (PUSH 234 235) (PUSH 235 236)
                                   (PUSH 236 237) (PUSH 237 238) (PUSH 238 239) (PUSH 239 240) (PUSH 240 241)
                                   (PUSH 241 242) (PUSH 242 243) (PUSH 243 244) (PUSH 244 245) (PUSH 245 246)
                                   (PUSH 246 247) (PUSH 247 248) (PUSH 248 249) (PUSH 249 250) (PUSH 250 251)
                                   (PUSH 251 252) (PUSH 252 253) (PUSH 253 254) (PUSH 254 255) (PUSH 255 256)
                                   (PUSH 256 257) (PUSH 257 258) (PUSH 258 259) (PUSH 259 260) (PUSH 260 261)
                                   (PUSH 261 262) (PUSH 262 263) (PUSH 263 264) (PUSH 264 265) (PUSH 265 266)
                                   (PUSH 266 267) (PUSH 267 268) (PUSH 268 269) (PUSH 269 270) (PUSH 270 271)
                                   (PUSH 271 272) (PUSH 272 273) (PUSH 273 274) (PUSH 274 275) (PUSH 275 276)
                                   (PUSH 276 277) (PUSH 277 278) (PUSH 278 279) (PUSH 279 280) (PUSH 280 281)
                                   (PUSH 281 282) (PUSH 282 283) (PUSH 283 284) (PUSH 284 285) (PUSH 285 286)
                                   (PUSH 286 287) (PUSH 287 288) (PUSH 288 289) (PUSH 289 290) (PUSH 290 291)
                                   (PUSH 291 292) (PUSH 292 293) (PUSH 293 294) (PUSH 294 295) (PUSH 295 296)
                                   (PUSH 296 297) (PUSH 297 298) (PUSH 298 299) (PUSH 299 300) (PUSH 300 301)
                                   (PUSH 301 302) (PUSH 302 303) (PUSH 303 304) (PUSH 304 305) (PUSH 305 306)
                                   (PUSH 306 307) (PUSH 307 308) (PUSH 308 309) (PUSH 309 310) (PUSH 310 311)
                                   (PUSH 311 312) (PUSH 312 313) (PUSH 313 314) (PUSH 314 315) (PUSH 315 316)
                                   (PUSH 316 317) (PUSH 317 318) (PUSH 318 319) (PUSH 319 320) (PUSH 320 321)
                                   (PUSH 321 322) (PUSH 322 323) (PUSH 323 324) (PUSH 324 325) (PUSH 325 326)
                                   (PUSH 326 327) (PUSH 327 328) (PUSH 328 329) (PUSH 329 330) (PUSH 330 331)
                                   (PUSH 331 332) (PUSH 332 333) (PUSH 333 334) (PUSH 334 335) (PUSH 335 336)
                                   (PUSH 336 337) (PUSH 337 338) (PUSH 338 339) (PUSH 339 340) (PUSH 340 341)
                                   (PUSH 341 342) (PUSH 342 343) (PUSH 343 344) (PUSH 344 345) (PUSH 345 346)
                                   (PUSH 346 347) (PUSH 347 348) (PUSH 348 349) (PUSH 349 350) (PUSH 350 351)
                                   (PUSH 351 352) (PUSH 352 353) (PUSH 353 354) (PUSH 354 355) (PUSH 355 356)
                                   (PUSH 356 357) (PUSH 357 358) (PUSH 358 359) (PUSH 359 360) (PUSH 360 361)
                                   (PUSH 361 362) (PUSH 362 363) (PUSH 363 364) (PUSH 364 365) (PUSH 365 366)
                                   (PUSH 366 367) (PUSH 367 368) (PUSH 368 369) (PUSH 369 370) (PUSH 370 371)
                                   (PUSH 371 372) (PUSH 372 373) (PUSH 373 374) (PUSH 374 375) (PUSH 375 376)
                                   (PUSH 376 377) (PUSH 377 378) (PUSH 378 379) (PUSH 379 380) (PUSH 380 381)
                                   (PUSH 381 382) (PUSH 382 383) (PUSH 383 384) (PUSH 384 385) (PUSH 385 386)
                                   (PUSH 386 387) (PUSH 387 388) (PUSH 388 389) (PUSH 389 390) (PUSH 390 391)
                                   (PUSH 391 392) (PUSH 392 393) (PUSH 393 394) (PUSH 394 395) (PUSH 395 396)
                                   (PUSH 396 397) (PUSH 397 398) (PUSH 398 399) (PUSH 399 400) (PUSH 400 401)
                                   (PUSH 401 402) (PUSH 402 403) (PUSH 403 404) (PUSH 404 405) (PUSH 405 406)
                                   (PUSH 406 407) (PUSH 407 408) (PUSH 408 409) (PUSH 409 410) (PUSH 410 411)
                                   (PUSH 411 412) (PUSH 412 413) (PUSH 413 414) (PUSH 414 415) (PUSH 415 416)
                                   (PUSH 416 417) (PUSH 417 418) (PUSH 418 419) (PUSH 419 420) (PUSH 420 421)
                                   (PUSH 421 422) (PUSH 422 423) (PUSH 423 424) (PUSH 424 425) (PUSH 425 426)
                                   (PUSH 426 427) (PUSH 427 428) (PUSH 428 429) (PUSH 429 430) (PUSH 430 431)
                                   (PUSH 431 432) (PUSH 432 433) (PUSH 433 434) (PUSH 434 435) (PUSH 435 436)
                                   (PUSH 436 437) (PUSH 437 438) (PUSH 438 439) (PUSH 439 440) (PUSH 440 441)
                                   (PUSH 441 442) (PUSH 442 443) (PUSH 443 444) (PUSH 444 445) (PUSH 445 446)
                                   (PUSH 446 447) (PUSH 447 448) (PUSH 448 449) (PUSH 449 450) (PUSH 450 451)
                                   (PUSH 451 452) (PUSH 452 453) (PUSH 453 454) (PUSH 454 455) (PUSH 455 456)
                                   (PUSH 456 457) (PUSH 457 458) (PUSH 458 459) (PUSH 459 460) (PUSH 460 461)
                                   (PUSH 461 462) (PUSH 462 463) (PUSH 463 464) (PUSH 464 465) (PUSH 465 466)
                                   (PUSH 466 467) (PUSH 467 468) (PUSH 468 469) (PUSH 469 470) (PUSH 470 471)
                                   (PUSH 471 472) (PUSH 472 473) (PUSH 473 474) (PUSH 474 475) (PUSH 475 476)
                                   (PUSH 476 477) (PUSH 477 478) (PUSH 478 479) (PUSH 479 480) (PUSH 480 481)
                                   (PUSH 481 482) (PUSH 482 483) (PUSH 483 484) (PUSH 484 485) (PUSH 485 486)
                                   (PUSH 486 487) (PUSH 487 488) (PUSH 488 489) (PUSH 489 490) (PUSH 490 491)
                                   (PUSH 491 492) (PUSH 492 493) (PUSH 493 494) (PUSH 494 495) (PUSH 495 496)
                                   (PUSH 496 497) (PUSH 497 498) (PUSH 498 499) (PUSH 499 500) (PUSH 500 501)
                                   (PUSH 501 502) (PUSH 502 503) (PUSH 503 504) (PUSH 504 505) (PUSH 505 506)
                                   (PUSH 506 507) (PUSH 507 508) (PUSH 508 509) (PUSH 509 510) (PUSH 510 511)
                                   (PUSH 511 512) (PUSH 512 513) (PUSH 513 514) (PUSH 514 515) (PUSH 515 516)
                                   (PUSH 516 517) (PUSH 517 518) (PUSH 518 519) (PUSH 519 520) (PUSH 520 521)
                                   (PUSH 521 522) (PUSH 522 523) (PUSH 523 524) (PUSH 524 525) (PUSH 525 526)
                                   (PUSH 526 527) (PUSH 527 528) (PUSH 528 529) (PUSH 529 530) (PUSH 530 531)
                                   (PUSH 531 532) (PUSH 532 533) (PUSH 533 534) (PUSH 534 535) (PUSH 535 536)
                                   (PUSH 536 537) (PUSH 537 538) (PUSH 538 539) (PUSH 539 540) (PUSH 540 541)
                                   (PUSH 541 542) (PUSH 542 543) (PUSH 543 544) (PUSH 544 545) (PUSH 545 546)
                                   (PUSH 546 547) (PUSH 547 548) (PUSH 548 549) (PUSH 549 550) (PUSH 550 551)
                                   (PUSH 551 552) (PUSH 552 553) (PUSH 553 554) (PUSH 554 555) (PUSH 555 556)
                                   (PUSH 556 557) (PUSH 557 558) (PUSH 558 559) (PUSH 559 560) (PUSH 560 561)
                                   (PUSH 561 562) (PUSH 562 563) (PUSH 563 564) (PUSH 564 565) (PUSH 565 566)
                                   (PUSH 566 567) (PUSH 567 568) (PUSH 568 569) (PUSH 569 570) (PUSH 570 571)
                                   (PUSH 571 572) (PUSH 572 573) (PUSH 573 574) (PUSH 574 575) (PUSH 575 576)
                                   (PUSH 576 577) (PUSH 577 578) (PUSH 578 579) (PUSH 579 580) (PUSH 580 581)
                                   (PUSH 581 582) (PUSH 582 583) (PUSH 583 584) (PUSH 584 585) (PUSH 585 586)
                                   (PUSH 586 587) (PUSH 587 588) (PUSH 588 589) (PUSH 589 590) (PUSH 590 591)
                                   (PUSH 591 592) (PUSH 592 593) (PUSH 593 594) (PUSH 594 595) (PUSH 595 596)
                                   (PUSH 596 597) (PUSH 597 598) (PUSH 598 599) (PUSH 599 600) (PUSH 600 601)
                                   (PUSH 601 602) (PUSH 602 603) (PUSH 603 604) (PUSH 604 605) (PUSH 605 606)
                                   (PUSH 606 607) (PUSH 607 608) (PUSH 608 609) (PUSH 609 610) (PUSH 610 611)
                                   (PUSH 611 612) (PUSH 612 613) (PUSH 613 614) (PUSH 614 615) (PUSH 615 616)
                                   (PUSH 616 617) (PUSH 617 618) (PUSH 618 619) (PUSH 619 620) (PUSH 620 621)
                                   (PUSH 621 622) (PUSH 622 623) (PUSH 623 624) (PUSH 624 625) (PUSH 625 626)
                                   (PUSH 626 627) (PUSH 627 628) (PUSH 628 629) (PUSH 629 630) (PUSH 630 631)
                                   (PUSH 631 632) (PUSH 632 633) (PUSH 633 634) (PUSH 634 635) (PUSH 635 636)
                                   (PUSH 636 637) (PUSH 637 638) (PUSH 638 639) (PUSH 639 640) (PUSH 640 641)
                                   (PUSH 641 642) (PUSH 642 643) (PUSH 643 644) (PUSH 644 645) (PUSH 645 646)
                                   (PUSH 646 647) (PUSH 647 648) (PUSH 648 649) (PUSH 649 650) (PUSH 650 651)
                                   (PUSH 651 652) (PUSH 652 653) (PUSH 653 654) (PUSH 654 655) (PUSH 655 656)
                                   (PUSH 656 657) (PUSH 657 658) (PUSH 658 659) (PUSH 659 660) (PUSH 660 661)
                                   (PUSH 661 662) (PUSH 662 663) (PUSH 663 664) (PUSH 664 665) (PUSH 665 666)
                                   (PUSH 666 667) (PUSH 667 668) (PUSH 668 669) (PUSH 669 670) (PUSH 670 671)
                                   (PUSH 671 672) (PUSH 672 673) (PUSH 673 674) (PUSH 674 675) (PUSH 675 676)
                                   (PUSH 676 677) (PUSH 677 678) (PUSH 678 679) (PUSH 679 680) (PUSH 680 681)
                                   (PUSH 681 682) (PUSH 682 683) (PUSH 683 684) (PUSH 684 685) (PUSH 685 686)
                                   (PUSH 686 687) (PUSH 687 688) (PUSH 688 689) (PUSH 689 690) (PUSH 690 691)
                                   (PUSH 691 692) (PUSH 692 693) (PUSH 693 694) (PUSH 694 695) (PUSH 695 696)
                                   (PUSH 696 697) (PUSH 697 698) (PUSH 698 699) (PUSH 699 700) (PUSH 700 701)
                                   (PUSH 701 702) (PUSH 702 703) (PUSH 703 704) (PUSH 704 705) (PUSH 705 706)
                                   (PUSH 706 707) (PUSH 707 708) (PUSH 708 709) (PUSH 709 710) (PUSH 710 711)
                                   (PUSH 711 712) (PUSH 712 713) (PUSH 713 714) (PUSH 714 715) (PUSH 715 716)
                                   (PUSH 716 717) (PUSH 717 718) (PUSH 718 719) (PUSH 719 720) (PUSH 720 721)
                                   (PUSH 721 722) (PUSH 722 723) (PUSH 723 724) (PUSH 724 725) (PUSH 725 726)
                                   (PUSH 726 727) (PUSH 727 728) (PUSH 728 729) (PUSH 729 730) (PUSH 730 731)
                                   (PUSH 731 732) (PUSH 732 733) (PUSH 733 734) (PUSH 734 735) (PUSH 735 736)
                                   (PUSH 736 737) (PUSH 737 738) (PUSH 738 739) (PUSH 739 740) (PUSH 740 741)
                                   (PUSH 741 742) (PUSH 742 743) (PUSH 743 744) (PUSH 744 745) (PUSH 745 746)
                                   (PUSH 746 747) (PUSH 747 748) (PUSH 748 749) (PUSH 749 750) (PUSH 750 751)
                                   (PUSH 751 752) (PUSH 752 753) (PUSH 753 754) (PUSH 754 755) (PUSH 755 756)
                                   (PUSH 756 757) (PUSH 757 758) (PUSH 758 759) (PUSH 759 760) (PUSH 760 761)
                                   (PUSH 761 762) (PUSH 762 763) (PUSH 763 764) (PUSH 764 765) (PUSH 765 766)
                                   (PUSH 766 767) (PUSH 767 768) (PUSH 768 769) (PUSH 769 770) (PUSH 770 771)
                                   (PUSH 771 772) (PUSH 772 773) (PUSH 773 774) (PUSH 774 775) (PUSH 775 776)
                                   (PUSH 776 777) (PUSH 777 778) (PUSH 778 779) (PUSH 779 780) (PUSH 780 781)
                                   (PUSH 781 782) (PUSH 782 783) (PUSH 783 784) (PUSH 784 785) (PUSH 785 786)
                                   (PUSH 786 787) (PUSH 787 788) (PUSH 788 789) (PUSH 789 790) (PUSH 790 791)
                                   (PUSH 791 792) (PUSH 792 793) (PUSH 793 794) (PUSH 794 795) (PUSH 795 796)
                                   (PUSH 796 797) (PUSH 797 798) (PUSH 798 799) (PUSH 799 800) (PUSH 800 801)
                                   (PUSH 801 802) (PUSH 802 803) (PUSH 803 804) (PUSH 804 805) (PUSH 805 806)
                                   (PUSH 806 807) (PUSH 807 808) (PUSH 808 809) (PUSH 809 810) (PUSH 810 811)
                                   (PUSH 811 812) (PUSH 812 813) (PUSH 813 814) (PUSH 814 815) (PUSH 815 816)
                                   (PUSH 816 817) (PUSH 817 818) (PUSH 818 819) (PUSH 819 820) (PUSH 820 821)
                                   (PUSH 821 822) (PUSH 822 823) (PUSH 823 824) (PUSH 824 825) (PUSH 825 826)
                                   (PUSH 826 827) (PUSH 827 828) (PUSH 828 829) (PUSH 829 830) (PUSH 830 831)
                                   (PUSH 831 832) (PUSH 832 833) (PUSH 833 834) (PUSH 834 835) (PUSH 835 836)
                                   (PUSH 836 837) (PUSH 837 838) (PUSH 838 839) (PUSH 839 840) (PUSH 840 841)
                                   (PUSH 841 842) (PUSH 842 843) (PUSH 843 844) (PUSH 844 845) (PUSH 845 846)
                                   (PUSH 846 847) (PUSH 847 848) (PUSH 848 849) (PUSH 849 850) (PUSH 850 851)
                                   (PUSH 851 852) (PUSH 852 853) (PUSH 853 854) (PUSH 854 855) (PUSH 855 856)
                                   (PUSH 856 857) (PUSH 857 858) (PUSH 858 859) (PUSH 859 860) (PUSH 860 861)
                                   (PUSH 861 862) (PUSH 862 863) (PUSH 863 864) (PUSH 864 865) (PUSH 865 866)
                                   (PUSH 866 867) (PUSH 867 868) (PUSH 868 869) (PUSH 869 870) (PUSH 870 871)
                                   (PUSH 871 872) (PUSH 872 873) (PUSH 873 874) (PUSH 874 875) (PUSH 875 876)
                                   (PUSH 876 877) (PUSH 877 878) (PUSH 878 879) (PUSH 879 880) (PUSH 880 881)
                                   (PUSH 881 882) (PUSH 882 883) (PUSH 883 884) (PUSH 884 885) (PUSH 885 886)
                                   (PUSH 886 887) (PUSH 887 888) (PUSH 888 889) (PUSH 889 890) (PUSH 890 891)
                                   (PUSH 891 892) (PUSH 892 893) (PUSH 893 894) (PUSH 894 895) (PUSH 895 896)
                                   (PUSH 896 897) (PUSH 897 898) (PUSH 898 899) (PUSH 899 900) (PUSH 900 901)
                                   (PUSH 901 902) (PUSH 902 903) (PUSH 903 904) (PUSH 904 905) (PUSH 905 906)
                                   (PUSH 906 907) (PUSH 907 908) (PUSH 908 909) (PUSH 909 910) (PUSH 910 911)
                                   (PUSH 911 912) (PUSH 912 913) (PUSH 913 914) (PUSH 914 915) (PUSH 915 916)
                                   (PUSH 916 917) (PUSH 917 918) (PUSH 918 919) (PUSH 919 920) (PUSH 920 921)
                                   (PUSH 921 922) (PUSH 922 923) (PUSH 923 924) (PUSH 924 925) (PUSH 925 926)
                                   (PUSH 926 927) (PUSH 927 928) (PUSH 928 929) (PUSH 929 930) (PUSH 930 931)
                                   (PUSH 931 932) (PUSH 932 933) (PUSH 933 934) (PUSH 934 935) (PUSH 935 936)
                                   (PUSH 936 937) (PUSH 937 938) (PUSH 938 939) (PUSH 939 940) (PUSH 940 941)
                                   (PUSH 941 942) (PUSH 942 943) (PUSH 943 944) (PUSH 944 945) (PUSH 945 946)
                                   (PUSH 946 947) (PUSH 947 948) (PUSH 948 949) (PUSH 949 950) (PUSH 950 951)
                                   (PUSH 951 952) (PUSH 952 953) (PUSH 953 954) (PUSH 954 955) (PUSH 955 956)
                                   (PUSH 956 957) (PUSH 957 958) (PUSH 958 959) (PUSH 959 960) (PUSH 960 961)
                                   (PUSH 961 962) (PUSH 962 963) (PUSH 963 964) (PUSH 964 965) (PUSH 965 966)
                                   (PUSH 966 967) (PUSH 967 968) (PUSH 968 969) (PUSH 969 970) (PUSH 970 971)
                                   (PUSH 971 972) (PUSH 972 973) (PUSH 973 974) (PUSH 974 975) (PUSH 975 976)
                                   (PUSH 976 977) (PUSH 977 978) (PUSH 978 979) (PUSH 979 980) (PUSH 980 981)
                                   (PUSH 981 982) (PUSH 982 983) (PUSH 983 984) (PUSH 984 985) (PUSH 985 986)
                                   (PUSH 986 987) (PUSH 987 988) (PUSH 988 989) (PUSH 989 990)))

(fiveam:test queue-with-precomputed-block
  (let ((q (make-blocking-queue)))
    (loop
       with last-value = 1
       for cmd in *queue-test-block*
       for i from 2
       do (ecase (car cmd)
            (push (queue-push q i))
            (pop (let ((value (queue-pop q)))
                   (fiveam:is (> value last-value))
                   (setq last-value value)))))
    (loop
       until (empty-p q)
       do (fiveam:is (plusp (queue-pop q))))))
